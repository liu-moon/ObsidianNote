## 9.1 地图点
- 地图点：地图点是三维点，有时候也称为路标点，来自真实世界的三维物体有唯一的ID，不同帧中的特征点可能对应三维空间中的同一个三维点。
- 特征点：特征点是二维点，是特征提取得到的图像上的像素点。特征点通过三角化可以变成三维空间中的地图点。

### 9.1.1 平均观测方向及观测距离范围
地图点有几个重要的成员变量——mNormalVector、mfMaxDistance、mfMinDistance。其中，mNormalVector称为平均观测方向向量，该翻译和英文单词直译有些区别，但是如果了解了它的原理，就会感觉这里翻译得比较贴切。
因为同一个地图点可能同时被多帧观测到，所以把每个能观测到该地图点的帧所在的光心和该地图点连成一个向量并归一化为单位向量，如图9-1所示，然后将所有归一化向量累加并求平均，得到的就是平均观测方向向量。

![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20231023173910.png)

而mfMaxDistance、mfMinDistance表示最大距离、最小距离，是这样计算的：
- 首先计算参考关键帧相机光心到地图点的距离dist。
- 观测到该地图点的参考帧对应的特征点在金字塔中的层级数，记为level。
- 计算上一步中层级数对应的尺度因子$scale^{level}$。其中，代码中scale=1.2，金字塔总层级数n=8，level的范围是0~7。
- 最大距离为$dist*scale^{level}$，最小距离为$dist*scale^{level+1-n}$
为什么用参考关键帧呢？
我们先来看定义，该地图点的参考关键帧的定义是该地图点第一次创建时的关键帧。此时观察到的地图点应该是最“正”的方向。

### 9.1.2 最具代表性的描述子
一个地图点会被多个图像帧观测到，每次观测都对应图像上的一个特征点，但是地图点在投影匹配时只能对应一个特征描述子，如何从这么多的描述子中选择最具代表性的一个呢？
具体流程如下：
1. 获取该地图点所有有效的观测关键帧及对应特征点的索引。
2. 遍历观测到该地图点中所有关键帧，把对应的特征描述子都放在一个向量中。
3. 计算所有描述子之间的两两距离，找到和其他描述子具有最小距离中值的描述子，将其作为最具代表性的描述子。
最小距离中值的描述子该如何理解呢？他有什么物理意义吗？

![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20231023175457.png)

如图9-2（a）所示，蓝色圆点表示所有的描述子，黑色方框内的数字表示方框左右两个描述子的距离。为方便示例，用位置距离代替描述子距离，假设相邻圆点之间的距离为1。如果当前描述子从左到右数是第2个，那么当前描述子按照从左到右的顺序到其他描述子的距离分别为1、1、2、3、4、5，排序后的中值为2.5，也就是说当前描述子和其他描述子的距离中值为2.5。同理，在图9-2（b）中，当前描述子从左到右数是第4个，那么当前描述子按照从左到右的顺序到其他描述子的距离分别为3、2、1、1、2、3，排序后为1、1、2、2、3、3，排序后当前描述子和其他描述子的距离中值为2。依次移动当前描述子的位置，会得到更多的距离中值。当前描述子和其他描述子的距离中值最小的值最能代表这些描述子的特点，也就是我们要求的最具代表性的描述子。这就是它的物理意义。

### 9.1.3 预测地图点对应的特征点所在的金字塔尺度
源码中还根据地图点的深度来预测它对应的二维特征点的金字塔层级数。如图9-3所示，记最远距离为$d_{max}$，最近距离为$d_{min}$，金字塔尺度因子为$s$，层级$l \in [0,n-1]$，那么如何估计某个距离$d_{i}$所在的金字塔层级$l_i$呢？根据图9-3可以推导得到
$$\frac{d_{max}}{d_{i}} = s^{l_{i}}$$

两边取以$s$为底的对数，可得
$$l_i = log_{s}\frac{d_{max}}{d_{i}} = lg(\frac{d_{max}}{d_{i}}) / lg(s)$$

![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20231024143729.png)

### 9.1.4 新增地图点
我们来总结ORB-SLAM2中的新增地图点。
在第一阶段跟踪中的恒速模型跟踪中新增地图点。针对双目相机或RGB-D相机，找出上一帧中具有有效深度值不是地图点的特征点，将其中较近的点作为上一帧新的临时地图点，并记录在向量mlpTemporalPoints中。注意，这里因为是临时地图点，所以没有添加地图点的相互观测和属性信息（最佳描述子、平均观测方向、观测距离范围）。
当完成第二阶段跟踪后，清除这些临时地图点。
第二阶段跟踪结束后新建关键帧时，针对双目相机或RGB-D相机，找出当前帧中具有有效深度值且不是地图点的特征点，将其中较近的点作为当前帧的新的地图点。与函数Tracking::UpdateLastFrame()功能类似，不同之处是这里添加的是真正的地图点，会添加地图点和关键帧的相互观测和属性信息，如最佳描述子、平均观测方向、观测距离范围。
在局部建图线程中，用当前关键帧与相邻关键帧通过三角化生成新的地图点。这里地图点会添加相互观测和属性信息，如最佳描述子、平均观测方向、观测距离范围，并且会将新增地图点放到一个名为“最近新增地图点”的队列mlpRecentAddedMapPoints中，这些新增的地图点后续需要接受函数MapPointCulling的检验。
在局部建图线程中，将当前关键帧的地图点分别与一级、二级相连关键帧的地图点进行正向融合和反向融合。这里的融合包括替换或新增地图点，并且会添加相互观测。最后会统一更新地图点的属性信息。
### 9.1.5 地图点融合
地图点融合是怎么回事？为什么需要融合呢？
第8章讲解了如何通过投影匹配增加更多的匹配关系，进而增加地图点的数量。当地图点规模比较大时，其中会存在很多邻近的地图点，有的来自跟踪线程，有的来自局部建图线程，有的来自闭环线程，这些邻近的地图点很可能是同一个路标点在不同阶段形成的“影子”。因此，需要将这些地图点融合为一个地图点，这样不仅可以避免冗余，缩小地图点的规模，还能通过融合过程提高地图点的精度。
可以举一个具体的融合例子吗？
在ORB-SLAM2中，融合地图点主要出现在两个地方，在局部建图线程中，将当前关键帧的一级和二级相连关键帧对应的所有地图点投影到当前关键帧中。如果投影的地图点能匹配当前关键帧的特征点，并且该特征点有对应的地图点，那么选择这两个地图点中被观测数目最多的那个来替换两个地图点，这称为地图点替换；如果投影的地图点能匹配当前关键帧的特征点，而该特征点没有对应的地图点，那么新增该地图点和关键帧之间的观测关系，称为地图点新增。
在闭环线程中，我们将当前关键帧闭环匹配上的关键帧及其共视关键帧组成的所有地图点投影到当前关键帧中，然后执行上述地图点融合（替换或新增）操作。
下面我们对局部建图线程中的投影匹配融合函数进行说明，它的整个过程如下。
1. 做好准备工作。取出当前帧位姿、内参、光心在世界坐标系下的坐标。
2. 开始遍历所有地图点，判断投影地图点是否有效。如果地图点不存在、无效、已经在当前帧中（无需融合），则跳过该地图点，遍历下一个地图点。
3. 对于有效的地图点，将其投影到当前关键帧中的二维图像坐标。
4. 投影坐标需要在有效的图像范围内，地图点到关键帧相机光心的距离满足在有效范围内，地图点到光心的连线与该地图点的平均观测方向向量之间的夹角要小于60°。同时满足这些条件后继续下一步，否则跳过该地图点，遍历下一个地图点。
5. 根据地图点到相机光心的距离预测匹配点所在的金字塔尺度，确定搜索范围。确定候选匹配点。
6. 遍历候选匹配点，最佳候选匹配点要同时满足投影点和候选匹配点的距离在合理范围内（因此此时的位姿认为是准确的，投影位置也接近真实匹配点），以及投影点的描述子距离最小。
7. 根据匹配点对应的地图点情况执行地图点替换或新增。

## 9.2 关键帧
### 9.2.1 什么是关键帧

关键帧是SLAM中常用的一种选择图像帧的策略，一般称普通帧为非关键帧。通俗地理解，关键帧就是连续几个普通帧中最具代表性的一帧。
关键帧主要有以下几个作用。
1. 关键帧可以降低信息冗余度。假设相机输出帧率为25帧/s，那么平均两个普通帧之间的时间间隔是40ms。在这么短的时间内，相机运动幅度有限，所以相邻帧之间大部分内容是一样的。如果在定位和建图时不加取舍，那么不仅需要处理的帧数目增加了很多，而且很多处理是没有太大意义的，因为重复的内容太多了。所以，需要从一定数量或时间间隔的普通帧中选择一帧作为它们的代表，关键帧承载的内容可以覆盖这部分普通帧的信息，这样可以极大地降低信息冗余度。举一个例子，当相机静止放置时，输出的普通图像帧数目会一直增加，当然它们的内容都一样，但此时关键帧数目不会增加。
2. 关键帧可以降低计算负担，减少误差累积。如果所有帧全部参与计算，那么不仅浪费了算力，内存也面临极大的考验，这在对实时性要求较高的SLAM系统中根本无法接接受。使用关键帧不仅能够降低算力和内存占用，还能参与到后端优化中，及时调整自身位姿，减少误差累积。尤其是在嵌入式系统等算力有限的平台，关键帧策略可以将有限的计算资源用在刀刃上，保证系统平稳运行。举一个例子，在ORB-SLAM2中，局部建图、闭环线程都只使用了关键帧。如果在跟踪线程中放松关键帧选择的约束条件，则会产生比正常情况下多几倍的关键帧，这会导致局部建图线程中局部BA优化规模非常大，一次优化会消耗更久的时间，不仅无法及时地优化更新关键帧的位姿，还会反过来影响跟踪效果。
3. 关键帧可以保证图像帧的质量。在很多视觉SLAM系统中，选择关键帧时还会对图像质量、特征点数目等因素进行考查，选择图像较为清晰、纹理特征较为丰富的普通帧作为关键帧；在Bundle Fusion、RKD SLAM等RGB-D SLAM系统中，也会将普通帧的深度图投影到关键帧中进行深度图增强优化，提高关键帧的质量，防止错误的信息通过关键帧进入优化过程，从而破坏定位和建图的准确性。

### 9.2.2 如何选择关键帧
选择关键帧主要从**关键帧自身**和**关键帧与其他关键帧的关系**两方面来考虑。
1. 关键帧自身质量要好。比如当相机快速运动时，尽量选择其中不模糊的图像，在弱纹理环境下尽量选择特征点数量较多的图像等。
2. 关键帧与其他关键帧之间要保持合适的连接关系。比如关键帧既要和局部地图中的其他关键帧有一定的共视关系，又不能重复度太高，达到**即存在约束**，**又尽量减少信息冗余**的效果。
在ORB-SLAM2中，主要是通过关键帧和其他关键帧的关系来选择关键帧的，所以这里进行重点介绍。选择关键帧的量化指标主要如下。
- 距离上一关键帧的帧数是否足够多（时间）。比如每隔固定帧数选择一个关键帧，这样编程虽然简单，但效果不好。举一个例子，当相机运动很慢甚至静止时，就会选择大量相似的冗余关键帧，而当相机快速运动时，又可能丢失很多重要的帧。
- 距离最近关键帧的距离是否足够远（空间）。比如和距离最近的关键帧计算运动的相对大小，这里的“运动”既可以是位移，也可以是旋转，或者二者兼有。当“运动”超过一定的阈值时，新建一个关键帧。这种方法相比第一种方法稍好。但是如果相机对着同一个物体来回做往复运动，则也会出现大量冗余的相似关键帧。
- 跟踪局部地图质量（共视特征点数目）。记录当前视角下成功跟踪的地图点数目或者比例，这样就避免了使用第二种方法出现的问题，只有当相机离开当前场景时，才会新建关键帧。
在ORB-SLAM2中，结合以上几种指标选择关键帧。选择关键帧的策略是，在跟踪线程中，创建关键帧的约束条件比较宽松，但在后续的局部建图线程中会严格筛选，剔除冗余的关键帧。这样做的目的是，在大旋转、快速运动、纹理不足等恶劣情况下提高跟踪的鲁棒性，从而大大降低跟丢的概率。
### 9.2.3 如何选择并创建关键帧
跟踪分为两个阶段，当完成第二阶段的跟踪（局部地图跟踪）后，就需要根据当前跟踪的状态来判断是否需要插入关键帧。
先来看在什么情况下不需要插入关键帧呢？
- 在仅定位跟踪模式下不需要插入关键帧。因为在该模式下只有跟踪线程，没有局部建图和闭环线程。
- 如果局部建图线程正在被闭环线程使用，则不插入关键帧
- 如果距离上一次重定位比较近（1s以内），则不插入关键帧
- 如果地图中关键帧数目已经超出最大限制，则不插入关键帧
而在什么情况下需要插入关键帧相对比较复杂，分条件1和条件2，条件1又分a、b、c三个条件。
- 条件1a：距离上次插入关键帧超过1s。认为时间比较久了
- 条件1b：满足插入关键帧的最小间隔，并且局部建图线程处于空闲状态
- 条件1c：在双目相机或RGB-D相机模式下，当前帧跟踪到的点比参考关键帧跟踪到的点不足1/4，或者跟踪到的近点太少且没有跟踪到的近点较多，两者满足其一即可，我们称为满足近点条件
条件1成立需要满足1a||1b||1c，也就是说1a、1b、1c三个条件中只要有一个满足即可认为条件1成立。
条件2也有三个条件，具体如下。
- 条件2a：和参考帧相比，当前帧跟踪到的点数目太少，小于阈值比例。这个比例在单目相机模式下是0.9，在双目相机或RGB-D相机模式下是0.75，在关键帧小于2帧时是0.4。这个比例越高，插入频率越高。
- 条件2b：满足近点条件，同条件1c。
- 条件2c：成功跟踪到的匹配内点数目大于15。
条件2成立需要满足(2a||2b)&&2c，也就是说2a和2b两个条件中至少满足一个，同时满足2c，才能认为条件2成立。
插入关键帧还有两个阶段。
- 阶段1：条件1、条件2同时成立。此时进入阶段2。
- 阶段2：如果此时局部建图线程空闲，则插入关键帧；如果此时局部建图线程繁忙，则通知中断局部建图线程中的局部BA过程；如果是单目相机模式，则先不插入关键帧；如果是双目相机或RGB-D相机模式，并且局部建图线程中待处理的关键帧少于3帧，则插入关键帧，否则不插入。
什么是近点呢？为什么要强调这个近点？
在ORB-SLAM2中，近点的讨论仅针对双目相机或RGB-D相机模式，它的定义为相机基线长度的40倍。也就是说，我们认为在这个距离内，双目相机立体匹配恢复的深度值比较准，因为更远的点视差太小，三角化误差会比较大；RGB-D相机测量的深度值也在可靠范围内，因为量程有限。
图9-4所示是近点和远点的直观例子，绿色的点表示近点，蓝色的点表示远点。近点可以恢复出比较准确的平移向量，但是远点只对估计旋转有用，对平移和尺度的估计都不准确。所以，当我们发现近点数目不足、远点增多时，就需要插入关键帧，保证正确跟踪，估计准确的位姿。
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20231031164259.png)
为什么插入关键帧的条件这么复杂呢？
确实，这么多条件看起来很绕，但是我们仔细去分析背后的原理，就可以发现几个影响关键帧插人的主要因素。比如跟踪到的地图点数目太少、大久没有插入关键帧、有效的近点太少等，如果不及时增加关键帧，则可能会导致跟踪丢失。再如局部建图线程空闲还是繁忙，这直接关系到能否正常插入满足条件的关键帧。而局部建图线程中最耗时的部分就是局部BA，参与优化的关键顺数目和地图点都会影响计算量，所以也要控制局部BA的范围，以免影响关键帧插入。
当确定要插入关键帧时，就把当前普通帧包装成关键帧，如果是双目相机或RGB-D相机模式，则还会选择具有有效深度值但没有被跟踪到的三维点，包装为该关键帧的地图点，最后将关键帧送入局部建图线程中。
### 9.2.4 更新关键帧之间的共视关系
每次新建关键帧时也需要新建和它相连关键帧的关系。当关键帧的地图点发生变化时，需要更新和它相连关键帧之间的联系，具体步骤如下。
第1步，获得该关键帧的所有地图点，通过地图点被关键帧观测来间接统计关键帧之间的共视程度（权重）。
第2步，建立共视关系需要大于或等于15个共视地图点，当前帧和符合条件的这些共视关键帧建立连接。如果没有超过15个共视地图点的关键帧，则只对权重最大的关键帧建立连接。
第3步，按照共视程度从大到小对所有共视关键帧进行排列。
第4步，更新关键帧的父子关系。初始化当前关键帧的父关键帧为共视程度最高的关键帧，将当前关键帧作为其子关键帧。
根据共视关系，我们还定义了关键帧的邻接关系，常用的是一级相连关键帧和二级相连关键帧。如图9-5所示，当前关键帧记为KF，则KF的一级相连关键帧位于图9-5中的红色椭圆形内，二级相连关键帧位于图9-5中的绿色椭圆形内。一起来看看这是如何构造的。
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20231031165627.png)
（1）一级相连关键帧。满足和KF具有一定共视关系的关键帧，称为KF的级相连关键帧（图9-5中的KF1、KF2）。这里的共视地图点的数目可以自己定义。
（2）二级相连关键帧。满足和KF1、KF2具有一定共视关系的关键帧，称为KF的二级相连关键帧。这里的共视地图点的数目也可以自己定义。
### 9.2.5 删除关键帧
由于关键帧之间的联系比较复杂，因此如果要删除一个关键帧，就会产生“牵一发而动全身”的效应，需要清除和该关键帧相连关键帧的联系，需要清除该关键帧观测到的地图点的联系，需要为该关键帧的子关键帧重新寻找合适的父关键帧。前面两个操作相对容易，第三个操作会比较复杂，它涉及整个关键帧的父子关系，处理不好会造成整个关键帧维护的生成树（见后续介绍）的断裂或混乱。
这里主要介绍为待删除关键帧的子关键帧重新寻找合适的父关键帧。由于涉及的变量比较多，我们统一定义，如表9-1所示。
表9-1    为待删除关键帧的子关键帧重新寻找合适的父关键帧涉及的变量

| 变量              | 含义                                                                               |
| ----------------- | ---------------------------------------------------------------------------------- |
| mpParent          | 当前待删除关键帧的父关键帧                                                         |
| sParentCandidates | 候选父关键帧，初始化时只有一个元素——mpParent                                       |
| mspChildrens      | 当前待删除关键帧的子关键帧，可能有多个                                             |
| pKF               | 当前待删除关键帧的某个子关键帧，mspChildrens中的一个元素                           |
| vpConnected       | 和pKF共视的关键帧                                                                  |
| pC                | vpConnected和sParentCandidates中相同的元素中和pKF共视程度最高的子关键帧            |
| pP                | vpConnected和sParentCandidates中相同的元素中和pKF共视程度最高的vpConnected中的元素 |
todo


### 9.2.6 关键帧的分类
1. 父关键帧和子关键帧
	当新建一个关键帧时，初始化当前关键帧的父关键帧为和它共视程度最高的关键帧，将当前关键帧作为其子关键帧。当关键帧被删除时，需要更新关键帧的父子关系。
2. 参考关键帧
	在跟踪局部地图中，在当前帧的一级共视关键帧中，将与它共视程度最高的关键帧作为当前帧的参考关键帧。在跟踪线程中，将最新建立的关键帧作为当前帧的参考关键帧。


## 9.3 图结构
在ORB-SLAM2中，由关键帧构成了几种非常重要的图结构，包括共视图、本质图和生成树。
### 9.3.1 共视图
我们先来看图9-8（a），其中蓝色表示上面提到的关键帧，需要注意的是，后续所提到的共视图、本质图和生成树都是由关键帧构成的，和普通帧无关；绿色表示当前相机的位置；红色的点表示局部地图点；红色的点和黑色的点组成了所有的地图点。
图9-8（b）所示为共视图。共视图是无向加权图，每个顶点都是关键帧。如果两个关键帧之间满足一定的共视关系（至少有15个共视地图点），则它们就会连成一条边，边的权重就是共视地图点数目。
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20231101194241.png)
共视图贯穿在整个ORB-SLAM2流程中，下面列举几个共视图在其中的应用。
（1）在跟踪线程中。通过共视图构建当前帧的局部地图，增加了投影匹配的地图点数目，增加了匹配点对。图9-8（a）中绿色表示当前帧，未使用共视图时能够投影到它的地图点非常有限，而通过共视图构建的局部地图几乎占了整个地图的一半，大大增加了投影匹配的地图点数目。
（2）在局部建图线程中。用当前关键帧与和它相邻的共视关键帧通过三角化产生更多新的地图点，使得跟踪更稳定。
（3）在闭环线程中。寻找闭环候选关键帧及筛查满足连续性条件的闭环候选关键帧时，多次使用共视关系建立关键帧组，这样能够保证闭环候选关键帧足够可靠。
（4）在本质图优化中。将共视程度较高的关键帧之间的约束作为边加入优化。
### 9.3.2 本质图
有了共视图，为什么还需要本质图呢？
在闭环矫正环节，通常使用位姿图优化的方法将闭环时的误差沿着位姿图进行分摊。但由于共视图中关键帧之间的联系非常紧密，因此优化时速度会很慢。为了能够在加速优化的同时保证优化结果的精度，我们就构建了一种图结构一本质图（Essential Graph）。如图9-9（b）所示，本质图中保留了所有的顶点（关键帧），但是减少了顶，点之间连接的边，它只保留了联系紧密的边，从而保证优化结果精度比较高。
本质图中边的连接关系如下。
- 生成树连接关系。
- 形成闭环的连接关系，闭环后地图，点变动后新增加的连接关系。
- 共视关系非常好（至少有100个共视地图点）的连接关系。
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20231101194928.png)
为什么本质图比共视图少了很多边，但是优化结果仍然比较精确呢？这有什么依据吗？
根本原因是本质图保留了最重要的边，去掉了相对不那么重要的边，优化时效率更高，收敛更快。
### 9.3.3 生成树
生成树（Spanning Tree）由子关键帧和父关键帧构成。它是共视图的一个子图，具有最少的边。当新插入一个关键帧时，它就和生成树中和它共视程度最高的关键帧建立了连接；当需要删除一个关键帧时，系统会更新受到该关键帧影响的连接关系。生成树的示意图如图9-10所示，其中箭头方向表示父节点指向子节点的连接关系。所有关键帧中父子关系构成的连接关系都称为生成树。非父子关系之间的连接关系会被抛弃，体现在图9-10中就变成了孤立的点（图9-10中的蓝色点）。
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20231101195339.png)
