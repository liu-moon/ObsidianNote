ORB（Oriented FAST and Rotated BRIEF）特征点出自美国公司在2012年发表的一篇论文
## ORB特征点
特征点由关键点（Keypoint）和描述子（Descriptor）两部分组成。
关键点：特征点在图像中的位置
描述子：量化关键点周围的像素信息
这里的“量化”一般是认为设计的某种方式，设计的原则是“外观相似的特征应该具有相似的描述子”。
如果想判断两个位置的关键点是否相似时，可以通过计算他们之间的描述子距离来确定。
ORB的关键点为Oriented FAST，描述子为Steered BRIEF。
### 关键点 Oriented FAST
#### FAST角点
FAST角点是一种检测角点的方法。这种方法确定特征点的速度非常快。
判断是否是角点可以通过在图像中取一个小窗口，窗口内的像素如果沿所有方向都有灰度变化，说明该点是角点。
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20230922131440.png)
在FAST中不再需要使用窗口统计的思想，而是通过另一种更快的方式，总的来说就是：如果一个像素和它周围的像素灰度差别较大（超过设定的阈值），而且达到一定数目，那么这个像素就很可能是角点。
具体的检测过程如下：
1. 在图像中选择某个像素$p$，将它的灰度值记为$I_p$
2. 设定一个阈值$T$，用于判断两个像素灰度值的差异大小。为了能够适应不同的图像，一般采用相对百分比例，比如设置为$I_p$的20%。
3. 以像素$p$为中心，选取半径为3的圆上的16个像素点。选取方式如下图所示。
   ![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20230922131945.png)
4. 如果16个像素点中有连续的N个点的灰度大于$I_p+T$或者小于$I_p-T$，就可以将像素$p$确定为关键点。在ORB论文中，作者说$N=9$时效果较好，称为FAST-9。在实际操作中，为了加速，可以把第1、5、9、13个像素点当作锚点。在FAST-9算法中，只有当这4个锚点中有3个及以上锚点的灰度值同时大于$I_p+T$或者小于$I_p-T$时，当前像素才可能是一个关键点，否则就可以排除掉，这大大加快了关键点检测的速度。
5. 遍历图像中每个像素点，循环执行以上4个步骤。

#### 图像金字塔
但是FAST角点还存在尺度问题，所谓的尺度问题产生的原因如下：
由于FAST固定选取的是半径为3的圆，那这个关键点就和相机拍摄物体的分辨率息息相关了，当在初始位置通过FAST-9判定是关键点，但是当相机靠近或者后退的时候，该点的大小发生变化，又因为固定选取的半径是不变的，就会产生无法检测到该点的情况。
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20230922133001.png)
ORB特征点使用图像金字塔来确保特征点的尺度不变性。图像金字塔是计算机视觉领域中常用的一种方法，如图所示
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20230922133027.png)
金字塔底层是原始图像，在ORB-SLAM2中对应的金字塔层级是level=0。每往上一层，就对图像进行一个固定倍率的缩放，得到不同分辨率的图像。当提取ORB特征点时，我们会在每一个金字塔层级上进行特征提取，这样不管相机拍摄时距离物体是远还是近，都可以在某个金字塔层级上提取到真正的角点。我们在对不同图像特征点进行匹配时，就可以匹配不同图像中在不同金字塔层级上提取到的特征点，实现尺度不变性。
#### 灰度质心法
ORB特征点的旋转不变性是通过以下方式实现的：
先想办法计算出每个关键点的“主方向”，然后统一将像素旋转到这个“主方向”，使得每个特征点的描述子不再受旋转的影响。
计算关键点的主方向的方法为灰度质心法。这里的灰度质心就是将一个图像区域内像素的灰度值作为权重的中心，是需要我们计算的。这里的图像区域一般是圆形区域，在ORB-SLAM2中设定的是直径为31的圆形。这个圆形的圆心叫做形心，也就是几何中心。形心指向质心的向量就代表这个关键点的“主方向”。
我们定义该区域图像的矩为（类似物理中的力矩）：
$$m_{pq} = \sum_{x,y}x^py^qI(x,y),\quad  p,q=\left \{ 0,1 \right \} $$
式中，$p,q$取0或1；$I(x,y)$表示在像素坐标$(x,y)$处图像的灰度值；$m_{pq}$表示图像的矩。
图形区域内所有像素的灰度值总和为
$$\begin{align}{} 
  m_{00} = \sum_{x=-R}^{R}\sum_{y=-R}^{R}I(x,y)
\end{align}$$
在半径为$R$的圆形图像区域，沿两个坐标轴$x,y$方向的图像矩分别为
$$\begin{align}{} 
  m_{10} = \sum_{x=-R}^{R}\sum_{y=-R}^{R}xI(x,y)\\m_{01} = \sum_{x=-R}^{R}\sum_{y=-R}^{R}yI(x,y)
\end{align}$$
图像的质心为
$$\begin{align} 
  C = \left ( c_x,c_y \right )=\left ( \frac{m_{10}}{m_{00}}, \frac{m_{01}}{m_{00}} \right )  
\end{align}$$
关键点的“主方向”可以表示为从圆形图像形心$O$指向质心$C$的方向向量$\overrightarrow{OC}$，于是关键点的旋转角度记为
$$\theta = arctan2(c_y,c_x)= arctan2(m_{01},m_{10})$$
以上就是利用灰度质心法求关键点旋转角度的原理。
ORB-SLAM2代码使用了一些技巧加速计算灰度质心，原理和流程如下：
![](https://cdn.jsdelivr.net/gh/liu-moon/pic@main/img/20230923102320.png)

1. 要处理的是一个圆形图像区域，加速的原理是根据对称性一次索引多行像素。首先把索引基准点放在圆形的中心像素点上，记为center
2. 图形半径记为R，先计算圆形区域内水平坐标轴上的一行像素灰度（图中红色区域），对应的坐标范围是（-R<x<R,y=0）。这一行对应的图像矩分别为
   $$\begin{align}{} 
  m_{10}^{center} &= \sum_{-R<x<R,y=0}xI(x,y)\\m_{01}^{center} &= \sum_{-R<x<R,y=0}yI(x,y)=0
\end{align}$$
3. 以水平坐标轴为对称轴，一次性索引与水平坐标轴上下对称的两行像素（图中绿色区域），上下某两个对称的像素分别记为
   $$\begin{align}{} 
  p_{up} &= (x',-y')\\p_{bottom} &= (x',y')
\end{align}$$
则这两个点对应的图像矩分别为
$$\begin{align}{} 
  m_{10}^{up'} &= x'I(p_{bottom})+x'I(p_{up}) = x'(I(x',y')+I(x',-y'))\\
  m_{01}^{bottom'} &= y'I(p_{bottom})-y'I(p_{up}) = y'(I(x',y')-I(x',-y'))
\end{align}$$
最后累加即可。

