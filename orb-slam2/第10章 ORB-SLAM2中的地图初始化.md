## 10.1 为什么需要初始化
SLAM中的初始化通常是指地图的初始化（如无特殊说明，第二部分讲的初始化均为地图初始化），也就是生成最初的地图。在ORB-SLAM2中，初始化和使用的传感器类型有关，其中在单目相机模式下初始化相对复杂，需要运行一段时间才能成功。而在双目相机、RGB-D相机模式下初始化比较简单，一般在第一帧就可以完成。
对于最简单的RGB-D相机初始化来说，因为该相机可以直接输出RGB图像和对应的深度图像，所以每个像素点对应的深度值是确定的。也就是说，在第一顺提取了特征点后，特征点对应的三维点在空间中的绝对坐标是可以计算出来的（需要用到内参）。对于双日相机初始化来说，也可以通过第一帧左右目图像立体匹配来得到特征点对应的三维点在空间中的绝对坐标。因为第一帧的三维点是作为地图来实现跟踪的，所以这些三维点也称为地图点。所以，从理论上来说，双目相机、RGB-D相机在第一帧就可以完成初始化。而对于单目相机初始化来说，仅有第一帧还无法得到三维点，要想初始化，需要像双日相机那样进行立体匹配。
双日相机能够直接用第一帧进行左右日图像立体匹配有一个隐含条件，就是左右日具有一定的物理距离，而且这个距离是可以提前通过相机标定得到的。该距离不能太近，否则无法进行三角化得到三维点。所以，在单目相机模式下，需要相机移动一定的距离并且满足必要的条件，才能够完成初始化。此外，由于单目相机无法知道“移动一定的距离”对应的绝对距离，因此得到的三维点是缺乏尺度信息的，是一个相对坐标。
缺乏尺度会带来一系列的问题，这里先列举几个例子，以后我们讲到时再讨论。
- 没有绝对尺度会导致位姿和地图点都和真实世界相差一个未知的比例，因此无法应用在测距相关领域。不过，可以借助其他传感器恢复尺度，比如在ORB-SLAM3中通过引入IMU计算出单目相机模式下的尺度。
- 我们可以在初始化时固定某个参考尺度，但是在跟踪过程中很可能会产生尺度漂移。
- 在闭环时需要计算当前帧和闭环候选帧之间的尺度，并进行误差均摊。
### 10.2 单目模式地图初始化
ORB-SLAM2中的单日初始化和应用场景无关，不管初始化时的场景是平面的还是非平面的，都可以自动完成初始化，无须人工干预。我们先来看单目初始化需要的前提条件。
- 参与初始化的两帧各自特征点的数目都需要大于100。
- 两帧特征点成功匹配的数目需要大于或等于100。
- 两帧特征点三角化成功的三维点数目需要大于50。
ORB-SLAM2中有很多参数，比如这里的100、50都是经验参数，是作者在640像素×480像素的分辨率下测试效果比较好的经验值。当然，和这个相近的分辨率也可以使用这套参数。所以，如果要用ORB-SLAM2代码，则需要尽量将图像缩放到该分辨率附近。
第1个条件只需要判断图像中特征点的数目满足条件即可，第2个条件中的特征匹配会在后面讲解。第3个条件中的三角化是重点，具体流程如下。
第1步，记录当前帧和参考帧（第1帧）之间的特征匹配关系。
第2步，在特征匹配点对中随机选择8对匹配点作为一组。
第3步，用这8对点分别计算基础矩阵F（Fudamentalmatrix）和单应矩阵H（Homographymatrix），并得到得分。
第4步，计算得分比例，据此判断选取基础矩阵还是单应矩阵求位姿和三角化。
### 10.2.1 求单应矩阵
师兄：在初始化中，单应矩阵主要用于平面场景中的位姿估计。求单应矩阵的步骤如下。
第1步，对特征匹配点坐标进行归一化。
第2步，开始选代，每次选择8对点计算单应矩阵。
第3步，根据当次计算的单应矩阵的重投影误差对结果进行评分。
第4步，重复第2、3步，以得分最高的单应矩阵作为最优的单应矩阵。
#### 坐标归一化
因为我们的8对点是随机选取的，所以特征点可能分布在图像的任何地方，这可能会导致坐标值的量级差别比较大。如果不对数据进行预处理，直接求解单应矩阵或基础矩阵，则会带来较大的误差。
预先对特征点图像坐标进行归一化有以下好处：能够提高运算结果的精度；利用归一化处理后的图像坐标，对尺度缩放和原点的选择不敏感。归一化步骤预先为图像坐标选择了一个标准的坐标系，消除了坐标变换对结果的影响。
所以，建议在用8点法求单应矩阵或基础矩阵之前，先对特征点坐标进行归一化处理。
归一化操作步骤如下。
第1步,假设共有N对特征点,计算特征点坐标$\left( x _ { i } , y _ { i } \right),i= 1…,N$ ，分别在两个坐标轴方向上的均值$m e an X$、$meanY$:
$$\begin{array}{c} 
  meanX = \frac {\sum_{i=1}^{N}x _ { i } } { N } \\ 
  meanY = \frac {\sum_{i=1}^{N}y _ { i } } { N } 
\end{array}$$
第2步，求出平均到每个点上，其坐标偏离均值$meanX$、$meanY$的程度，记为$meanDevX$、$meanDevY$，并将其倒数作为一个尺度缩放因子$sX$、$sY$：
$$\begin{aligned}
& \text { meanDev } X=\sum_{i=1}^N \frac{\| x_i-\text { mean } X \|}{N}=\frac{1}{s X} \\
& \text { meanDev } Y=\sum_{i=1}^N \frac{\| y_i-\text { mean } Y \|}{N}=\frac{1}{s Y}
\end{aligned}$$
第 3 步, 用均值和尺度缩放因子对坐标进行归一化, 归一化后的坐标记为 $\left(x_i^{\prime}, y_i^{\prime}\right), i=1, \cdots, N$ :
$$
\begin{aligned}
x_i^{\prime} & =s X\left(x_i-\operatorname{mean} X\right) \\
y_i^{\prime} & =s Y\left(y_i-\operatorname{mean} Y\right)
\end{aligned}
$$

第 4 步, 用矩阵表示上述变换关系, 得到归一化矩阵 $\boldsymbol{T}$ :
$$
\left[\begin{array}{c}
x_i^{\prime} \\
y_i^{\prime} \\
1
\end{array}\right]=\left[\begin{array}{ccc}
s X & 0 & -s X * \text { mean } X \\
0 & s Y & -s Y * \text { mean } Y \\
0 & 0 & 1
\end{array}\right]\left[\begin{array}{c}
x_i \\
y_i \\
1
\end{array}\right]=\boldsymbol{T}\left[\begin{array}{c}
x_i \\
y_i \\
1
\end{array}\right]
$$
尺度缩放因子的作用是为了控制噪声对图像坐标的影响，让其保持在同一个数量级上。
#### 求解单应矩阵
前面讲解了如何对特征点进行归一化，下面推导如何利用特征点求解单应矩阵 $\boldsymbol{H}$
特征匹配点分别为 $\boldsymbol{p}_1=\left[u_1, v_1, 1\right]^{\top}, \boldsymbol{p}_2=\left[u_2, v_2, 1\right]^{\top}$, 用单应矩阵 $\boldsymbol{H}_{21}$ 描述特征点对之间的变换关系:
$$
\boldsymbol{p}_2=\boldsymbol{H}_{21} \boldsymbol{p}_1
$$
写成矩阵形式为
$$
\left[\begin{array}{c}
u_2 \\
v_2 \\
1
\end{array}\right]=\left[\begin{array}{lll}
h_1 & h_2 & h_3 \\
h_4 & h_5 & h_6 \\
h_7 & h_8 & h_9
\end{array}\right]\left[\begin{array}{c}
u_1 \\
v_1 \\
1
\end{array}\right]
$$
为了转化为齐次方程, 左右两边同时叉乘 $\boldsymbol{p}_2$, 得到
$$
\boldsymbol{p}_{\mathbf{2}} \times \boldsymbol{H}_{21} \boldsymbol{p}_{\mathbf{1}}=0
$$
写成矩阵形式为
$$
\left[\begin{array}{ccc}
0 & -1 & v_2 \\
1 & 0 & -u_2 \\
-v_2 & u_2 & 0
\end{array}\right]\left[\begin{array}{lll}
h_1 & h_2 & h_3 \\
h_4 & h_5 & h_6 \\
h_7 & h_8 & h_9
\end{array}\right]\left[\begin{array}{c}
u_1 \\
v_1 \\
1
\end{array}\right]=0
$$
结果展开并整理得到
$$
\begin{aligned}
& v_2=\left(h_4 u_1+h_5 v_1+h_6\right) /\left(h_7 u_1+h_8 v_1+h_9\right) \\
& u_2=\left(h_1 u_1+h_2 v_1+h_3\right) /\left(h_7 u_1+h_8 v_1+h_9\right)
\end{aligned}
$$
整理成齐次方程为
$$
\begin{aligned}
-\left(h_4 u_1+h_5 v_1+h_6\right)+\left(h_7 u_1 v_2+h_8 v_1 v_2+h_9 v_2\right) & =0 \\
h_1 u_1+h_2 v_1+h_3-\left(h_7 u_1 u_2+h_8 v_1 u_2+h_9 u_2\right) & =0
\end{aligned}
$$
再转化为矩阵形式
$$
\left[\begin{array}{ccccccccc}
0 & 0 & 0 & -u_1 & -v_1 & -1 & u_1 v_2 & v_1 v_2 & v_2 \\
u_1 & v_1 & 1 & 0 & 0 & 0 & -u_1 u_2 & -v_1 u_2 & -u_2
\end{array}\right]\left[\begin{array}{l}
h_1 \\
h_2 \\
h_3 \\
h_4 \\
h_5 \\
h_6 \\
h_7 \\
h_8 \\
h_9
\end{array}\right]=0
$$
等式左边两项分别用$\boldsymbol{A}$,$\boldsymbol{h}$表示，则有
$$
\boldsymbol{A}\boldsymbol{h}=0
$$
通过上面的结论可以发现，一对特征点可以提供两个约束方程。单应矩阵的自由度是8，所以只需要4对点提供8个约束方程就可以求解了。
为什么单应矩阵自由度是8呢？
从单应矩阵和特征点的变换关系来看，等式右边是0，也就是说该等式左右两边同时乘以一个不为0的数，等式恒成立，这称为尺度等价性。单应矩阵H共有9个元素，去掉1自由度，就是8自由度。
刚才说计算单应矩阵只需要4对特征点即可，为什么ORB-SLAM2中使用了8对特征点呢？